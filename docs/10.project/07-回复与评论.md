<!--
 * @Author: 孙浩然
 * @Date: 2020-05-22 09:02:47
 * @LastEditors: 孙浩然
 * @LastEditTime: 2020-05-24 23:14:11
 * @FilePath: \docs\10.project\07-回复与评论.md
 * @博客地址: 个人博客，如果各位客官觉得不错，请点个赞，谢谢。[地址](https://codefool0307.github.io/JavaScholar/#/)
--> 
# 7 博客功能

## 7.1 文章发布

因为之前完成了关于发起问题的页面设计

![avatar](./assets/7-1.jpg)

那么应该需要什么内容呢？仿照ES设置回复数和浏览数，点赞数等功能

首先创建question的数据库，V3__Create_question_table

创建完成之后，放在了db的V3

```java
create table question
(
    id int auto_increment primary key,
    title varchar(50),
    description text,
    gmt_create bigint,
    gmt_modified bigint,
    creator int,
    comment_count int default 0,
    view_count int default 0,
    like_count int default 0,
    tag varchar(256)
);
```
之后mvn flyway:migration

![avatar](./assets/7-2.jpg)

那么生成完毕之后，
然后开始写数据库文件，创建一个questionmapper

同时写question类

```java
public class Question implements Serializable {

    private Integer id;
    
    private String title;
    
    private String description;
    
    private Long gmtCreate;
    
    private Long gmtModified;
    
    private Integer creator;
    
    private Integer commentCount;
    
    private Integer viewCount;
    
    private Integer likeCount;
    
    private String tag;
```
注：直接使用的是EasyCode插件可以自动生成

```java
@Mapper
public interface QuestionMapper {
     @Insert("insert into question(title,description,gmt_modified,creator,tag) values (#{title},#{description},#{gmtCreate},#{gmtModified},#{creator},#{tag})")
    public void create(Question question);

}
```
之后，在public.html中对页面进行设置变量


在public  54行<form action="">写入/public，然后method=post，

注意：get渲染页面，post执行请求

```js
  <form action="/public" method="post">
                        <div class="form-group">
                            <label for="title">问题标题（简单扼要）:</label>
                            <input type="text" class="form-control" id="title" name="title"
                                   placeholder="问题标题……">
                        </div>
```

之后再publicController中再次创建一个方法，主要是针对于public.html来接收页面发来的请求

```java
@Controller
public class PublishController { 
     
@Autowired
    private QuestionMapper questionMapper;

@GetMapping("/publish")
    public String publish(Model model) {
        model.addAttribute("tags", TagCache.get());
        return "publish";
    }
@PostMapping("/publish")
    public String doPublish(
            @RequestParam(value = "title") String title,
            @RequestParam(value = "description") String description,
            @RequestParam(value = "tag") String tag，
            ) {
                 return "publish";}
```
之后再都dopublish中添加question的详细细节

```java
        Question question = new Question();
        question.setTitle(title);
        question.setDescription(description);
        question.setTag(tag);
```      
  
但是如何获取user呢，是通过IndexController方式的方式来获取

```java
 Cookie[] cookies = request.getCookies();
    for (Cookie s : cookies) {
        if (s.getName().equals("token")){
            String token = s.getValue();
            User user=userMapper.findByToken(token);
            if (user!=null){
                request.getSession().setAttribute("user",user);
            }
            break;
        }
```

那么这样之后，就要在参数里面注入HttpServletRequest

```java
 public String dopublish(
            @RequestParam("title") String title,
            @RequestParam("description") String description,
            @RequestParam("tag") String tag,
            HttpServletRequest httpServletRequest,
    ){

        return "public";
    }
```

同时如果我想把服务端的东西传入到页面，那么我就必须写入model中，

```java
  @PostMapping("/public")
    public String dopublish(
            @RequestParam("title") String title,
            @RequestParam("description") String description,
            @RequestParam("tag") String tag,
            HttpServletRequest httpServletRequest,
            Model model
    ){

        return "public";
    }
```

这样既可以往页面写东西了


```java
User user = null;

Cookie[] cookies = request.getCookies();
    for (Cookie s : cookies) {
        if (s.getName().equals("token")){
            String token = s.getValue();
            User user=userMapper.findByToken(token);
            if (user!=null){
                request.getSession().setAttribute("user",user);
            }
            break;
        }
    }

        if (user == null) {
            model.addAttribute("error", "用户未登录");
            return "publish";
        }
```

那么整个程序就可以写为：

```java
@PostMapping("/public")
    public String dopublish(
            @RequestParam("title") String title,
            @RequestParam("description") String description,
            @RequestParam("tag") String tag,
            HttpServletRequest request,
            Model model
    ){

        User user=null;
        Cookie[] cookies = request.getCookies();
        for (Cookie s : cookies) {
            if (s.getName().equals("token")){
                String token = s.getValue();
                user=userMapper.findByToken(token);
                if (user!=null){
                    request.getSession().setAttribute("user",user);
                }
                break;
            }
        }
        //如果user没有登录就失败
        if (user ==null){
            model.addAttribute("error","用户未登录");
        }

        Question question = new Question();
        question.setTitle(title);
        question.setDescription(description);
        question.setTag(tag);
        question.setCreator(user.getAccountId());
        question.setGmtCreate(System.currentTimeMillis());
        question.setGmtModified(question.getGmtCreate());
        //为什么需要一个create方法呢？
        questionMapper.create(question);
        return "redirect:/";
    }
}
```

为了实现能够显示错误信息，那么我们需要在public.html中根据boostrap的找到[警告框](https://v3.bootcss.com/components/#alerts)

![avatar](./assets/7-3.jpg)


开始修改public.html文件

```js

<span class="alert alert-danger" th:text="${error}"></span>
                        <button type="submit" class="btn btn-success">
                            发布
                        </button></form></div>

                <div class="col-lg-3 col-md-12 col-sm-12 col-xs-12">
                    <h3>问题发起指南</h3>
                    • 问题标题: 请用精简的语言描述您发布的问题，不超过25字 <br>
                    • 问题补充: 详细补充您的问题内容，并确保问题描述清晰直观, 并提供一些相关的资料<br>
                    • 选择标签: 选择一个或者多个合适的标签，用逗号隔开，每个标签不超过10个字<br>
                </div>
```

那么运行程序


出现问题














2302前

运行点击发布

会显示用户未登录

为了美观

publish中

2521后

-2709


题外话
因为登录后，我消失了，为了解决这个问题

去auhCon

中加入if (githubUser != null && githubUser.getId() != null) {


添加发布按钮

html index中加入

3035后

这样加比较麻烦，之后解释


运行程序

处理框框
加入if标签

th：if3230

发布一下，出现问题了，数据库可能出现问题


工作前，当页面点击完发布以后，发布的信息是没有的，如何添加呢

去publishController


 model.addAttribute("title", title);
        model.addAttribute("description", description);
        model.addAttribute("tag", tag);

并且在html中3550并使用th:text中放入

如何验证失败呢？那么校验一下如何


在publishCon中添加
if (StringUtils.isBlank(title)) {
            model.addAttribute("error", "标题不能为空");
            return "publish";
        }
        if (StringUtils.isBlank(description)) {
            model.addAttribute("error", "问题补充不能为空");
            return "publish";
        }
        if (StringUtils.isBlank(tag)) {
            model.addAttribute("error", "标签不能为空");
            return "publish";
        }

其中之后会用js校验

运行刷新页面发你。发布成功了，

但是如果在页面

问题标题上  写上   点击发布会出现标题为空

但是问题标题没有保存下来

为什么呢。吧model放在了下面

@PostMapping("/publish")
    public String doPublish(
            @RequestParam(value = "title",) String title,
            @RequestParam(value = "description") String description,
            @RequestParam(value = "tag") String tag,
        
            HttpServletRequest request,
            Model model) {
        model.addAttribute("title", title);
        model.addAttribute("description", description);
        model.addAttribute("tag", tag);
        model.addAttribute("tags", TagCache.get());

        if (StringUtils.isBlank(title)) {
            model.addAttribute("error", "标题不能为空");
            return "publish";
        }
        if (StringUtils.isBlank(description)) {
            model.addAttribute("error", "问题补充不能为空");
            return "publish";
        }
        if (StringUtils.isBlank(tag)) {
            model.addAttribute("error", "标签不能为空");
            return "publish";
        }

        String invalid = TagCache.filterInvalid(tag);
        if (StringUtils.isNotBlank(invalid)) {
            model.addAttribute("error", "输入非法标签:" + invalid);
            return "publish";
        }

        User user = (User) request.getSession().getAttribute("user");
        if (user == null) {
            model.addAttribute("error", "用户未登录");
            return "publish";
        }

        Question question = new Question();
        question.setTitle(title);
        question.setDescription(description);
        question.setTag(tag);
        question.setCreator(user.getId());
        question.setId(id);
        questionService.createOrUpdate(question);
        return "redirect:/";
    }
}


运行，点击

展示位置不对

去public.html中04253

改为th：field就可以了


运行


但是出错


把

@RequestParam(value = "title", required = false) String title,
            @RequestParam(value = "description", required = false) String description,
            @RequestParam(value = "tag", required = false) String tag,

运行出现错误

去更换方式


th：value方式

刷新运行




把首页做成ES这样的形式

我想去添加一个头像

去db中添加一个头像的属性

为什么不执行：

一定是大写V 数字递增两个下划线注意注意

那么创建一个V4

alter table user add avatar_url varchar(100) null;

然后mvn flyway：migrate运行在User添加属性private String avatarUrl;

这样执行太麻烦
用Lombok来完成去lombok官方文档看一下找到install

mavan方式使用@Data注解

去user代码

去user删除所有的getset方法

加入@Data注解

@Data
ublic class User {
    private Long id;        private String accountId;
    private String name;    private String token;
    private Long gmtCreate; private Long gmtModified;
    private String bio;     private String avatarUrl;



qustion一样


dto所有的类全部加入@Data

去usermapper中，加入avatar_url


去AuthController

获取头像，在githubUser加入avatr属性

并在里面设置user.setAvatarUrl(githubUser.getAvatarUrl());


重启服务器


删除所有的cookie因为没有退出。不会进行github登录


会出现错误。那么在indexCon加入判断1252

并在publish1300

点击登录


然后关闭运行程序，去数据库字段看看有没有头像字段


## 7.2 回复




## 7.3 评论